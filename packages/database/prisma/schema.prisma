generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum KycStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

enum Currency {
  BTC
  LTC
  USDT_TRC20
  USDT_ERC20
  UZS
}

enum Network {
  BTC
  LTC
  TRC20
  ERC20
}

enum EntryType {
  CREDIT
  DEBIT
  HOLD
  RELEASE
}

enum DepositStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
}

// Users
model User {
  id         String    @id @default(cuid())
  phone      String?   @unique
  telegramId String?   @unique
  username   String?   @unique
  password   String?
  kycStatus  KycStatus @default(NONE)
  isAdmin    Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  balances       Balance[]
  walletAddresses WalletAddress[]
  deposits       Deposit[]
  withdrawals    Withdrawal[]
  ledgerEntries  LedgerEntry[]
  trades         Trade[]
  p2pSent        P2pTransfer[]   @relation("P2pSender")
  p2pReceived    P2pTransfer[]   @relation("P2pReceiver")

  @@index([phone])
  @@index([telegramId])
  @@index([username])
}

// Balances (one per user+currency)
model Balance {
  id        String   @id @default(cuid())
  userId    String
  currency  Currency
  available Decimal  @db.Decimal(36, 18)
  held      Decimal  @db.Decimal(36, 18)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, currency])
  @@index([userId])
}

// Ledger Journal (immutable audit log)
model LedgerEntry {
  id            String    @id @default(cuid())
  userId        String
  currency      Currency
  amount        Decimal   @db.Decimal(36, 18)
  type          EntryType
  operation     String    // deposit, withdrawal, p2p, swap, withdrawal_complete, etc.
  referenceId   String    // ID of related entity (deposit, withdrawal, trade, etc.)
  balanceBefore Decimal   @db.Decimal(36, 18)
  balanceAfter  Decimal   @db.Decimal(36, 18)
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([operation])
  @@index([referenceId])
  @@index([createdAt])
}

// Wallet Addresses
model WalletAddress {
  id        String   @id @default(cuid())
  userId    String
  currency  Currency
  network   Network
  address   String   @unique
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([address])
}

// Deposits
model Deposit {
  id            String        @id @default(cuid())
  userId        String
  currency      Currency
  network       Network
  txHash        String        @unique
  amount        Decimal       @db.Decimal(36, 18)
  confirmations Int           @default(0)
  status        DepositStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([txHash])
}

// Withdrawals
model Withdrawal {
  id        String           @id @default(cuid())
  userId    String
  currency  Currency
  network   Network
  address   String
  amount    Decimal          @db.Decimal(36, 18)
  fee       Decimal          @db.Decimal(36, 18)
  txHash    String?
  status    WithdrawalStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// P2P Transfers
model P2pTransfer {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  currency   Currency
  amount     Decimal  @db.Decimal(36, 18)
  note       String?
  createdAt  DateTime @default(now())

  fromUser User @relation("P2pSender", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("P2pReceiver", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
}

// Trades (swaps)
model Trade {
  id           String   @id @default(cuid())
  userId       String
  fromCurrency Currency
  toCurrency   Currency
  fromAmount   Decimal  @db.Decimal(36, 18)
  toAmount     Decimal  @db.Decimal(36, 18)
  rate         Decimal  @db.Decimal(36, 18)
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Risk Flags (for AML/compliance)
model RiskFlag {
  id        String   @id @default(cuid())
  userId    String
  type      String   // large_withdrawal, suspicious_pattern, etc.
  severity  String   // low, medium, high, critical
  details   Json?
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([resolved])
}

// Admin Users (separate from regular users)
model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("admin") // admin, super_admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// System Settings
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}
